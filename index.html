<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solicita√ß√£o de Servi√ßo - Mois√©s Avelino Instituto Digital</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("cDfXutPGgZv2avweb"); // Public Key
    })();
  </script>

  <!-- Three.js + loaders + controls -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/STLLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/PLYLoader.js"></script>

  <style>
    :root{
      --brand:#25d366;
      --bg:#f5f5f5;
      --card:#fff;
      --text:#222;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, sans-serif;
      background:var(--bg);
      margin:0; padding:24px;
      color:var(--text);
    }
    .container{
      background:var(--card);
      max-width:900px;margin:0 auto;
      border-radius:16px;padding:22px;
      box-shadow:0 10px 25px rgba(0,0,0,.06);
    }
    header{
      display:flex;align-items:center;gap:16px;flex-wrap:wrap;justify-content:space-between;margin-bottom:8px;
    }
    .brand{
      display:flex;align-items:center;gap:14px;
    }
    .logo{
      display:block;height:auto;
      max-width:220px;
    }
    @media (max-width: 600px){
      .logo{max-width:130px;}
    }
    .ig-link{
      display:inline-flex;align-items:center;gap:8px;
      text-decoration:none;color:#111;font-weight:700;
      border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;
      background:#fff;
    }
    .ig-link img{width:22px;height:22px;border-radius:6px}
    h2{margin:0 0 6px 0;font-size:20px}
    p.sub{margin:0;color:var(--muted);font-size:13px}

    form label{font-weight:600;display:block;margin-top:10px}
    input, select, textarea{
      width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin-top:6px;font-size:15px
    }
    textarea{min-height:90px;resize:vertical}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:700px){.grid-2{grid-template-columns:1fr}}

    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:14px}
    .btn{border:0;border-radius:10px;padding:12px 16px;font-size:15px;cursor:pointer;}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-outline{background:#fff;border:1px solid #ddd}

    .viewer-card{
      margin-top:16px;border:1px solid #e5e7eb;border-radius:14px;padding:12px;
    }
    #viewer{width:100%;height:420px;background:#eef2f7;border-radius:10px;overflow:hidden}
    @media (max-width:600px){#viewer{height:320px}}
    .hint{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <img src="logo.jpeg" class="logo" alt="Logo Mois√©s Avelino">
        <div>
          <h2>Mois√©s Avelino ‚Äî Instituto Digital</h2>
          <p class="sub">Solicita√ß√£o de servi√ßos para laborat√≥rio de pr√≥tese</p>
        </div>
      </div>
      <a class="ig-link" href="https://www.instagram.com/instituto_moises_avelino_?igsh=MTV4dXM1ODI0eWExeQ%3D%3D&utm_source=qr" target="_blank" rel="noopener">
        <img src="instagram.svg" alt="Instagram"> Instagram
      </a>
    </header>

    <form id="form">
      <!-- EmailJS helper -->
      <input type="hidden" name="reply_to" value="centrodeusinagemmprotese@gmail.com">

      <div class="grid-2">
        <div>
          <label for="cliente">Cliente (Cl√≠nica/Dentista)</label>
          <input type="text" id="cliente" name="cliente" required>
        </div>
        <div>
          <label for="paciente">Paciente</label>
          <input type="text" id="paciente" name="paciente" required>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="cro">CRO (Opcional)</label>
          <input type="text" id="cro" name="cro">
        </div>
        <div>
          <label for="cpfcnpj">CPF/CNPJ (Opcional)</label>
          <input type="text" id="cpfcnpj" name="cpfcnpj">
        </div>
      </div>

      <label for="endereco">Endere√ßo (Opcional)</label>
      <input type="text" id="endereco" name="endereco">

      <div class="grid-2">
        <div>
          <label for="servico">Servi√ßo</label>
          <select id="servico" name="servico" required>
            <option value="">Selecione o Servi√ßo</option>
            <option value="Coroa de e-max">Coroa de e-max</option>
            <option value="Laminados e-max">Laminados e-max</option>
            <option value="Facetas">Facetas</option>
            <option value="Onlay/Inlay">Onlay/Inlay</option>
            <option value="Pr√≥tese sobre implante">Pr√≥tese sobre implante</option>
            <option value="Coroa zirc√¥nia">Coroa zirc√¥nia</option>
            <option value="Protocolo em zirc√¥nia">Protocolo em zirc√¥nia</option>
            <option value="PMMA">PMMA</option>
            <option value="Modelo impresso">Modelo impresso</option>
            <option value="Planejamento digital">Planejamento digital</option>
          </select>
        </div>
        <div>
          <label for="material">Material</label>
          <select id="material" name="material" required>
            <option value="">Selecione o Material</option>
            <option value="Zirc√¥nia">Zirc√¥nia</option>
            <option value="Emax">Emax</option>
            <option value="PMMA">PMMA</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="cor">Cor</label>
          <input type="text" id="cor" name="cor" placeholder="Ex.: A2" required>
        </div>
        <div>
          <label for="telefone">Telefone (opcional)</label>
          <input type="tel" id="telefone" name="telefone" placeholder="(DDD) n√∫mero">
        </div>
      </div>

      <label for="obs">Observa√ß√µes</label>
      <textarea id="obs" name="obs" placeholder="Instru√ß√µes adicionais..."></textarea>

      <label><b>Anexar Arquivos (.stl / .ply)</b> <span class="hint">Arquivos ser√£o enviados por e-mail</span></label>
      <input type="file" id="arquivos" name="arquivos" accept=".stl,.ply" multiple>

      <div class="actions">
        <button type="submit" class="btn btn-primary">Enviar</button>
        <a class="btn btn-outline" href="tabela_servicos.jpeg" download>üì• Baixar Tabela de Servi√ßos</a>
      </div>
    </form>

    <div class="viewer-card">
      <strong>Visualiza√ß√£o 3D (STL/PLY)</strong>
      <p class="hint">Carregue um arquivo para pr√©-visualiza√ß√£o local (n√£o envia nada ainda).</p>
      <input type="file" id="view3d" accept=".stl,.ply">
      <div id="viewer"></div>
    </div>
  </div>

  <script>
    // -------- WhatsApp + EmailJS --------
    document.getElementById("form").addEventListener("submit", function(e){
      e.preventDefault();
      
      const cliente = document.getElementById("cliente").value;
      const paciente = document.getElementById("paciente").value;
      const cro = document.getElementById("cro").value;
      const cpfcnpj = document.getElementById("cpfcnpj").value;
      const endereco = document.getElementById("endereco").value;
      const servico = document.getElementById("servico").value;
      const material = document.getElementById("material").value;
      const cor = document.getElementById("cor").value;
      const telefone = document.getElementById("telefone").value;
      const obs = document.getElementById("obs").value;
      const arquivos = document.getElementById("arquivos").files;

      let msg = `üìå *Solicita√ß√£o de Servi√ßo*\n\nüè• Cliente: ${cliente}\nüßë Paciente: ${paciente}`;
      if(cro) msg += `\nüî¢ CRO: ${cro}`;
      if(cpfcnpj) msg += `\nü™™ CPF/CNPJ: ${cpfcnpj}`;
      if(endereco) msg += `\nüìç Endere√ßo: ${endereco}`;
      msg += `\nü¶∑ Servi√ßo: ${servico}\n‚öôÔ∏è Material: ${material}\nüé® Cor: ${cor}`;
      if(telefone) msg += `\nüìû Telefone: ${telefone}`;
      msg += `\n‚úèÔ∏è Observa√ß√µes: ${obs}`;
      if(arquivos.length > 0) msg += `\nüìé Arquivos anexados ser√£o enviados por e-mail.`;

      const numero = "5571993209015";
      const url = `https://wa.me/${numero}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");

      emailjs.sendForm("service_omrmh59", "template_4hr7ydn", e.target)
        .then(function() {
          alert("‚úÖ Arquivos (selec.) e dados enviados por e-mail!");
        }, function(error) {
          alert("‚ùå Erro ao enviar por e-mail: " + JSON.stringify(error));
        });
    });

    // -------- Visualizador 3D --------
    const container = document.getElementById('viewer');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xEEF2F7);
    const camera = new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.01, 1000);
    camera.position.set(0, 0.2, 2.2);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const light = new THREE.HemisphereLight(0xffffff, 0x888888, 1);
    scene.add(light);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(2,3,4);
    scene.add(dir);

    const grid = new THREE.GridHelper(10, 10);
    grid.position.y = -0.5;
    scene.add(grid);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    let currentMesh = null;
    function clearMesh(){
      if(currentMesh){
        scene.remove(currentMesh);
        if(currentMesh.geometry) currentMesh.geometry.dispose();
        currentMesh = null;
      }
    }

    function fitView(object){
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());
      controls.reset();
      camera.position.copy(center);
      camera.position.z += size * 0.6 + 0.5;
      camera.lookAt(center);
      controls.target.copy(center);
    }

    function loadBuffer(arrayBuffer, ext){
      clearMesh();
      let geometry;
      if(ext === 'stl'){
        const loader = new THREE.STLLoader();
        geometry = loader.parse(arrayBuffer);
      }else{
        const loader = new THREE.PLYLoader();
        geometry = loader.parse(arrayBuffer);
        geometry.computeVertexNormals();
      }
      geometry.center();
      const material = new THREE.MeshStandardMaterial({metalness:0.05, roughness:0.8});
      const mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
      currentMesh = mesh;
      fitView(mesh);
    }

    function handleFile(file){
      const ext = file.name.toLowerCase().endsWith('.stl') ? 'stl' : 'ply';
      const reader = new FileReader();
      reader.onload = (ev)=> loadBuffer(ev.target.result, ext);
      reader.readAsArrayBuffer(file);
    }

    document.getElementById('view3d').addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(file) handleFile(file);
    });

    // Se o usu√°rio escolher anexos, tenta pr√©-visualizar o primeiro STL/PLY
    document.getElementById('arquivos').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []);
      const first = files.find(f => /\.(stl|ply)$/i.test(f.name));
      if(first) handleFile(first);
    });

    function onResize(){
      const w = container.clientWidth, h = container.clientHeight;
      camera.aspect = w/h; camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    }
    window.addEventListener('resize', onResize);

    (function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    })();
  </script>
</body>
</html>
